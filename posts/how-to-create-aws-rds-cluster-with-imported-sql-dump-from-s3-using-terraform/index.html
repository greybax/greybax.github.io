<!DOCTYPE html>
<html dir="LTR" lang="en">
  <head><!-- Google Adsense -->
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
       google_ad_client: "ca-pub-2866912874659895",
       enable_page_level_ads: true
      });
    </script><!-- /Google Adsense -->
    <meta charset="utf-8">
    <title>How to create AWS RDS cluster with imported SQL dump from S3 using Terraform</title><!-- Yandex Webmaster -->
    <meta name="yandex-verification" content="610e7b6bb48fc4d6"><!-- WoT Verification -->
    <meta name="wot-verification" content="6c0d169b1afe357fe29c"><!-- Pinterest Verification -->
    <meta name="p:domain_verify" content="e021b373eb236145372efe911356b021">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <meta name="author" content="Aleksandr Filatov">
    <link href="https://alfilatov.com/rss.xml" title="Aleksandr Filatov" rel="alternate" type="application/rss+xml"><!-- Open Sans -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,800,700&amp;subset=latin,cyrillic" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata:400&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css">
    <link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet"><!-- My Styles -->
    <link href="/css/styles.css" rel="stylesheet"><!-- highlight.js -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/monokai_sublime.min.css" rel="stylesheet">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>
    <script type="text/javascript">hljs.initHighlightingOnLoad();</script>
    <script async defer data-pin-hover="true" data-pin-tall="true" src="//assets.pinterest.com/js/pinit.js"></script>
    <meta property="og:site_name" content="Aleksandr Filatov">
    <meta property="article:author" content="https://alfilatov.com/about/">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@greybax">
    <meta name="keywords" content="aws, rds, s3, sql, terraform, devops, english">
    <meta name="description" content="How to create AWS RDS cluster with imported SQL dump from S3 using Terraform">
    <meta name="og:url" content="/posts/how-to-create-aws-rds-cluster-with-imported-sql-dump-from-s3-using-terraform/">
    <meta name="og:title" content="How to create AWS RDS cluster with imported SQL dump from S3 using Terraform">
    <meta name="og:description" content="aws, rds, s3, sql, terraform, devops, english"><!—- ShareThis BEGIN -—>
    <script async src="https://platform-api.sharethis.com/js/sharethis.js#property=5d2f8fb7735046001257ffab&amp;product='sticky-share-buttons'"></script><!—- ShareThis END -—>
  </head>
  <body>
    <header class="no-cover flex-header">
      <div class="to-main-page"><i class="fa fa-chevron-left"></i><a href="/">Main page</a></div>
      <div class="profile"><img src="https://www.gravatar.com/avatar/4ef97675943e8fe05f61adb948e42ef0?s=160" width="50" height="50">
        <nav>
          <ul>
            <li><a href="/about/">About</a></li>
          </ul>
        </nav>
      </div>
    </header>
    <div class="wrap-flex">
      <div class="related-posts"><span class="header">Related posts</span>
        <ul>
          <li><a href="/posts/my-contribution-in-mozilla-society/"> My contribution in Mozilla society </a></li>
          <li><a href="/posts/yandex-browser-it-need-or-not/"> Yandex browser - it's need or not? </a></li>
          <li><a href="/posts/windows-7-hotkeys/"> Windows 7 HotKeys </a></li>
          <li><a href="/posts/awesome-vscode-plugins/"> My VSCode settings </a></li>
          <li><a href="/posts/how-we-have-validated-the-theory-of-6-handshakes-six-degrees-of-separation-via-social-network/"> How we have validated the theory of 6 handshakes (six degrees of separation) via social network? </a></li>
        </ul>
        <div class="right-banner"><!-- Google Adsense -->
          <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><!-- google_adsense_right_article_banner --><ins style="display:inline-block;width:160px;height:600px" data-ad-client="ca-pub-2866912874659895" data-ad-slot="5210093029" class="adsbygoogle"></ins>
          <script>(adsbygoogle = window.adsbygoogle || []).push({});</script><!-- /Google Adsense -->
        </div>
      </div>
      <article>
        <div class="top-banner"><!-- Google Adsense -->
          <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><!-- google_adsense_top_article_banner --><ins style="display:inline-block;width:980px;height:120px" data-ad-client="ca-pub-2866912874659895" data-ad-slot="4549198145" class="adsbygoogle"></ins>
          <script>(adsbygoogle = window.adsbygoogle || []).push({});</script><!-- /Google Adsense -->
        </div><h1>How to create AWS RDS cluster with imported SQL dump from S3 using Terraform</h1><i class="fa fa-calendar">
          <time>September 04, 2021</time></i><br><i class="fa fa-tags"><a href="/tags/index.html#aws"> aws </a><a href="/tags/index.html#rds"> rds </a><a href="/tags/index.html#s3"> s3 </a><a href="/tags/index.html#sql"> sql </a><a href="/tags/index.html#terraform"> terraform </a><a href="/tags/index.html#devops"> devops </a><a href="/tags/index.html#english"> english </a></i><h2>Intro</h2>
<p>Recently during some DevOps things I've been working on pipeline creation which allows to test each branch independently from each other.
So the original task actually is pretty big, and I'd like to share one of the interesting case in this post. Most probably will write one more a little bit later.</p>
<h2>Task</h2>
<ol>
<li>Create AWS RDS cluster with instance using Terraform. </li>
<li>Instance should be restored from the existing dump stored on S3.</li>
</ol>
<h2>Solution</h2>
<p>Our solution will be based on following technologies:</p>
<ul>
<li><a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/Aurora.Overview.html">AWS RDS Aurora Cluster</a></li>
<li><a href="https://aws.amazon.com/pm/serv-s3">AWS S3</a></li>
<li><a href="https://www.terraform.io">Terraform</a></li>
<li><a href="https://github.com/features/actions">Github Actions</a></li>
</ul>
<p>In this post I will not describe how to setup until TF workspace. Assume that we've already set it up already.
So our first step will be copy <code>init.sql</code> dump to Terraform folder, since Terraform doesn't see anything outside of it.
Locally we will just copy/paste the file, but as I've mentioned above we are going create the pipeline which will do it automatically.
So we need to add copy/paste of our <code>init.sql</code> to our pipeline. In my case I've been using GH Actions:</p>
<p>Copy file action in <code>sandbox.yml</code> file:</p>
<pre><code>name: copy init.sql dump to Terraform folder
  run: cp -R ./drupal/getanswers/xtrabackup/init.sql.tar.gzf ./terraform/aws-sandbox/s3-data-upload/init.sql.tar.gz
</code></pre>
<p>Remove file action in <code>sandbox-cleanup.yml</code></p>
<pre><code>- name: remove sql dump from terraform/aws-sandbox folder
  run: rm -rf ./terraform/aws-sandbox/s3-data-upload/init.sql.tar.gz
</code></pre>
<blockquote>
<p><strong>Note:</strong> make sure that, sql dump has been created using <a href="https://www.percona.com/software/mysql-database/percona-xtrabackup">Percona XtraBackup tool</a>, otherwise RDS cluster will not be restored from S3.</p>
</blockquote>
<p>Below I'll provide my <code>rds.tf</code> config. Make sure that you will define variables by yourself.</p>
<pre><code># https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket
resource "aws_s3_bucket" "s3" {
  bucket = "s3-bucket-${var.your_name}"
  acl    = "private"

  tags = {
    Name        = "S3 Bucket with init.sql dump"
    Environment = var.workspace
  }
}

# https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket_object
resource "aws_s3_bucket_object" "init_sql" {
  bucket = aws_s3_bucket.s3.id
  key    = "init.sql.tar.gz"
  source = "${path.module}/init.sql.tar.gz00"
  etag   = filemd5("${path.module}/init.sql.tar.gz00")
}

# https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/rds_cluster
resource "aws_rds_cluster" "sandbox" {
  cluster_identifier  = "aurora-mysql-cluster-${var.your_name}"
  engine              = "aurora-mysql"
  engine_version      = "5.7.mysql_aurora.2.07.5"
  port                = 3306
  availability_zones  = slice(data.aws_availability_zones.available.names, 0, var.aws_az_count)
  master_username     = var.rds_master_username
  master_password     = var.rds_master_password
  skip_final_snapshot = true
  apply_immediately   = true

  lifecycle {
    ignore_changes = [engine_version]
  }

  # this is important peace which tell TF that this cluster should be restored from S3 dump file
  s3_import {
    source_engine         = "mysql"
    source_engine_version = "5.7"
    bucket_name           = aws_s3_bucket.s3.id
    ingestion_role        = aws_iam_role.s3_rds.arn
  }
}

# https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/rds_cluster_instance 
resource "aws_rds_cluster_instance" "cluster_instance" {
  count              = 1
  identifier         = "aurora-cluster-instance-${count.index}"
  cluster_identifier = aws_rds_cluster.sandbox.id
  instance_class     = "db.t3.small"
  engine             = aws_rds_cluster.sandbox.engine
  engine_version     = aws_rds_cluster.sandbox.engine_version

  lifecycle {
    ignore_changes = [engine_version]
  }
}
</code></pre>
<p>Actually this step goes before step 2 in the TF execution pipeline, but we will keep it here just for better understanding.
Terraform is smart enough to resolve resource executions if they depend on each other.</p>
<p>File <code>security.tf</code> with appropriate IAM Roles and permissions:</p>
<pre><code>resource "aws_iam_role" "s3_rds" {
  name_prefix = "rds-s3-integration-role-"

  assume_role_policy = &#x3C;&#x3C;EOF
{
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Principal": {
            "Service": "rds.amazonaws.com"
          },
         "Action": "sts:AssumeRole"
       }
     ]
   }
EOF
}

resource "aws_iam_role_policy" "s3_rds" {
  name_prefix = "rds-s3-integration-policy-"
  role        = aws_iam_role.s3_rds.name

  policy = &#x3C;&#x3C;EOF
{
    "Version": "2012-10-17",
    "Statement": [
      {
          "Effect": "Allow",
          "Action": "s3:ListAllMyBuckets",
          "Resource": "*"
      },
      {
          "Effect": "Allow",
          "Action": [
              "s3:ListBucket",
              "s3:GetBucketACL",
              "s3:GetBucketLocation"
          ],
          "Resource": "arn:aws:s3:::${aws_s3_bucket.s3.bucket}"
      },
      {
          "Effect": "Allow",
          "Action": [
              "s3:GetObject",
              "s3:PutObject",
              "s3:ListMultipartUploadParts",
              "s3:AbortMultipartUpload"
          ],
          "Resource": "arn:aws:s3:::${aws_s3_bucket.s3.bucket}/*"
      }
    ]
}
EOF
}
</code></pre>
<h2>Result</h2>
<p>Run </p>
<ul>
<li><code>terraform plan</code></li>
<li><code>terraform apply</code></li>
</ul>
<p>if your setup is correct you should be able to see follow results on AWS Dashboard:</p>
<p><strong>S3</strong></p>
<p><img src="/images/how-to-create-aws-rds-cluster-with-imported-sql-dump-from-s3-using-terraform/s3.png" alt="S3 bucket"></p>
<p><strong>RDS</strong></p>
<p><img src="/images/how-to-create-aws-rds-cluster-with-imported-sql-dump-from-s3-using-terraform/rds.png" alt="RDS Cluster"></p>
<p><em>Happy creating your own RDS cluster on AWS with Terraform!</em> :)</p>
      </article>
    </div>
    <div class="wrap"><!-- Google Adsense -->
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><!-- google_adsense_bottom_article_banner --><ins style="display:block" data-ad-client="ca-pub-2866912874659895" data-ad-slot="2846418099" data-ad-format="auto" data-full-width-responsive="true" class="adsbygoogle"></ins>
      <script>(adsbygoogle = window.adsbygoogle || []).push({});</script><!-- /Google Adsense --><!-- Disqus -->
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        (function() {
           var d = document, s = d.createElement('script');    
           s.src = '//alfilatov.disqus.com/embed.js';
           s.setAttribute('data-timestamp', +new Date());
           (d.head || d.body).appendChild(s);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><!-- /Disqus -->
    </div><!-- Yandex.Metrika counter -->
    <script type="text/javascript">
      (function (d, w, c) {
         (w[c] = w[c] || []).push(function() {
             try {
                 w.yaCounter25504124 = new Ya.Metrika({id:25504124,
                         clickmap:true,
                         trackLinks:true,
                         accurateTrackBounce:true});
             } catch(e) { }
         });
         var n = d.getElementsByTagName("script")[0],
             s = d.createElement("script"),
             f = function () { n.parentNode.insertBefore(s, n); };
         s.type = "text/javascript";
         s.async = true;
         s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";
         if (w.opera == "[object Opera]") {
             d.addEventListener("DOMContentLoaded", f, false);
         } else { f(); }
      })(document, window, "yandex_metrika_callbacks");
    </script>
    <noscript>
      <div><img src="//mc.yandex.ru/watch/25504124" style="position:absolute; left:-9999px;" alt=""></div>
    </noscript><!-- /Yandex.Metrika counter --><!-- Google Analytics -->
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-86970863-1', 'auto');
      ga('send', 'pageview');
    </script><!-- /Google Analytics -->
  </body>
  <footer>
    <hr>
    <center>Made with ❤ and <a href="https://gulpjs.com/">Gulp </a>♦ <a href="https://travis-ci.org/">Travis CI</a>♦ <a href="https://pages.github.com/">GitHub Pages</a></center>
  </footer>
</html>